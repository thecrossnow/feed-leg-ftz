name: ğŸ“° Atualizar Feed Fortaleza Simples

on:
  schedule:
    - cron: "0 */1 * * *"  # Executa todo inÃ­cio de hora (UTC)
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read
      checks: read

    steps:

      # -----------------------------------------------------------
      - name: ğŸ“¥ Checkout (com histÃ³rico completo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # -----------------------------------------------------------

      - name: ğŸ•’ Mostrar horÃ¡rio atual (UTC e Brasil)
        run: |
          echo "---- HorÃ¡rio Atual ----"
          echo "UTC:    $(date -u)"
          echo "BRASIL: $(TZ='America/Fortaleza' date)"
          echo "-----------------------------------"

      # -----------------------------------------------------------
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      # -----------------------------------------------------------

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install requests beautifulsoup4 lxml || exit 1

      # -----------------------------------------------------------
      - name: ğŸš€ Executar script com captura de erro
        run: |
          echo "ğŸ”„ Rodando upnewsfortaleza.py..."
          set -e
          python upnewsfortaleza.py
          echo "âœ… Script executado!"
      # -----------------------------------------------------------

      - name: ğŸ“‚ Verificar arquivo gerado
        run: |
          if [[ -f "feed_fortaleza_hoje.xml" ]]; then
            echo "ğŸŸ¢ Arquivo feed_fortaleza_hoje.xml encontrado."
            ls -lh feed_fortaleza_hoje.xml
          else
            echo "ğŸ”´ ERRO FATAL: Arquivo feed_fortaleza_hoje.xml NÃƒO foi gerado!"
            exit 1
          fi
      # -----------------------------------------------------------

      - name: ğŸ” Verificar se houve mudanÃ§as
        id: gitcheck
        run: |
          git status --porcelain
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhuma atualizaÃ§Ã£o detectada. Nada para commitar."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ HÃ¡ mudanÃ§as a serem commitadas."
          fi
      # -----------------------------------------------------------

      - name: ğŸ’¾ Commit e Pull + Push (sem travar)
        if: steps.gitcheck.outputs.changed == 'true'
        run: |
          echo "ğŸ“ Preparando commit..."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add feed_fortaleza_hoje.xml

          COMMIT_MSG="ğŸ¤– Update automÃ¡tico: $(TZ='America/Fortaleza' date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"

          echo "ğŸ”„ Sincronizando com repositÃ³rio remoto (git pull --rebase)..."
          git pull --rebase || true

          echo "ğŸ“¤ Fazendo push..."
          git push

          echo "âœ… AlteraÃ§Ãµes enviadas com sucesso!"
      # -----------------------------------------------------------

      - name: â„¹ï¸ Log final
        run: |
          echo "ğŸ‰ Workflow concluÃ­do!"
          echo "Finalizado em: $(date -u)"
