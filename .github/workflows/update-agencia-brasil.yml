name: Update Ag√™ncia Brasil Feed

on:
  schedule:
    - cron: '0 */1 * * *'  # A cada 1 hora
  workflow_dispatch:       # Execu√ß√£o manual

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      - name: üì• Checkout (com hist√≥rico completo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      # -----------------------------------------------------------

      - name: üêç Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 requests lxml
          echo "‚úÖ Depend√™ncias instaladas"

      - name: üöÄ Executar script de extra√ß√£o
        id: scraper
        run: |
          echo "üîç Verificando arquivos existentes..."
          ls -la *.py *.xml 2>/dev/null || echo "Nenhum arquivo encontrado"
          
          echo ""
          echo "üîç Executando script upnewsagenciabr.py..."
          python upnewsagenciabr.py
          
          echo ""
          echo "üìÅ Verificando arquivos gerados..."
          ls -la *.xml
          
          # Verificar qual arquivo foi gerado
          if [ -f "feed_agenciabrasil_wp.xml" ]; then
            FEED_FILE="feed_agenciabrasil_wp.xml"
          elif [ -f "feed_agenciabrasil.xml" ]; then
            FEED_FILE="feed_agenciabrasil.xml"
            echo "‚ö†Ô∏è  Usando arquivo antigo: $FEED_FILE"
          else
            echo "‚ùå ERRO: Nenhum arquivo XML foi gerado!"
            echo "Listando todos os arquivos:"
            ls -la
            exit 1
          fi
          
          # Contar itens no feed
          ITEMS=$(grep -c '<item>' "$FEED_FILE" 2>/dev/null || echo "0")
          
          # Contar apenas itens do tipo post (se for o arquivo WP)
          if [ "$FEED_FILE" = "feed_agenciabrasil_wp.xml" ]; then
            POST_ITEMS=$(grep -c '<wp:post_type>post</wp:post_type>' "$FEED_FILE" 2>/dev/null || echo "0")
          else
            POST_ITEMS=$ITEMS
          fi
          
          echo "üìä Estat√≠sticas do feed:"
          echo "   Arquivo: $FEED_FILE"
          echo "   Total de itens: $ITEMS"
          echo "   Posts (not√≠cias): $POST_ITEMS"
          
          # Salvar vari√°veis
          echo "FEED_FILE=$FEED_FILE" >> $GITHUB_ENV
          echo "ITEMS_TOTAL=$ITEMS" >> $GITHUB_ENV
          echo "POSTS_COUNT=$POST_ITEMS" >> $GITHUB_ENV
          
          # Extrair data da √∫ltima atualiza√ß√£o
          if [ -f "$FEED_FILE" ]; then
            LAST_BUILD=$(grep -oP '<lastBuildDate>\K[^<]+' "$FEED_FILE" 2>/dev/null | head -1 || echo "")
            if [ -n "$LAST_BUILD" ]; then
              echo "LAST_BUILD_DATE=$LAST_BUILD" >> $GITHUB_ENV
            fi
          fi

      # -----------------------------------------------------------
      - name: üîß Configurar git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
      # -----------------------------------------------------------

      - name: üîç Verificar mudan√ßas
        id: gitcheck
        run: |
          echo "üîç Verificando status do git..."
          git status
          
          echo ""
          echo "üîç Verificando mudan√ßas espec√≠ficas..."
          
          # Verificar se h√° qualquer mudan√ßa
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "üü° Mudan√ßas detectadas!"
            echo "Arquivos modificados/novos:"
            git status --porcelain
            
            echo "changed=true" >> $GITHUB_OUTPUT
            
            # Mostrar diff para debug
            echo ""
            echo "üìã Diff dos arquivos XML:"
            git diff --name-only | grep '\.xml$' || echo "Nenhum diff de XML"
            
          else
            echo "‚ÑπÔ∏è Nenhuma mudan√ßa detectada."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------------------------------------
      - name: üíæ Commit e Push
        if: steps.gitcheck.outputs.changed == 'true'
        run: |
          echo "üíæ Preparando commit..."
          
          # Adicionar todos os arquivos XML
          git add *.xml
          
          echo "üìã Status ap√≥s git add:"
          git status --porcelain
          
          # Obter hora de Bras√≠lia
          HORA_BRT=$(TZ="America/Sao_Paulo" date '+%d/%m/%Y %H:%M')
          
          # Mensagem de commit
          COMMIT_MSG="üì∞ Atualiza√ß√£o Ag√™ncia Brasil - $HORA_BRT"
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="üìä ${{ env.POSTS_COUNT }} not√≠cias | Total itens: ${{ env.ITEMS_TOTAL }}"
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="üìÅ Arquivo: ${{ env.FEED_FILE }}"
          
          # Commit
          git commit -m "$COMMIT_MSG"
          
          echo "üîÑ Sincronizando com reposit√≥rio remoto..."
          
          # Primeiro, fazer fetch
          git fetch origin
          
          # Tentar merge com a branch main
          echo "Merging com origin/main..."
          git merge origin/main --no-edit || echo "Merge pode ter conflitos, continuando..."
          
          echo "üì§ Enviando altera√ß√µes..."
          
          # Tentar push normal
          if git push origin main; then
            echo "‚úÖ Push conclu√≠do com sucesso!"
          else
            echo "üîÑ Push falhou, tentando com --force-with-lease..."
            git push --force-with-lease origin main
          fi
          
          echo ""
          echo "üìù Detalhes do commit:"
          git log -1 --oneline

      # -----------------------------------------------------------
      - name: üìÑ Criar arquivo de status
        run: |
          echo "üìù Criando arquivo de status..."
          
          # Garantir que temos os valores
          FEED_FILE="${FEED_FILE:-feed_agenciabrasil_wp.xml}"
          ITEMS_TOTAL="${ITEMS_TOTAL:-0}"
          POSTS_COUNT="${POSTS_COUNT:-0}"
          
          cat > feed_status.json << EOF
          {
            "repository": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "timestamp_brt": "$(TZ='America/Sao_Paulo' date +'%Y-%m-%d %H:%M:%S')",
            "status": "${{ job.status }}",
            "stats": {
              "feed_file": "$FEED_FILE",
              "total_items": $ITEMS_TOTAL,
              "posts_count": $POSTS_COUNT,
              "has_changes": ${{ steps.gitcheck.outputs.changed == 'true' }}
            },
            "urls": {
              "raw_feed": "https://raw.githubusercontent.com/${{ github.repository }}/main/$FEED_FILE",
              "workflow_run": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "repository": "https://github.com/${{ github.repository }}"
            }
          }
          EOF
          
          echo "‚úÖ Status salvo em feed_status.json"
          cat feed_status.json

      # -----------------------------------------------------------
      - name: üì§ Fazer upload dos arquivos gerados
        if: steps.gitcheck.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-feeds
          path: |
            *.xml
            feed_status.json
          retention-days: 7

      # -----------------------------------------------------------
      - name: üìä Resumo final
        run: |
          echo ""
          echo "====================================="
          echo "         AG√äNCIA BRASIL FEED"
          echo "====================================="
          echo "üìÖ Execu√ß√£o: $(TZ='America/Sao_Paulo' date '+%d/%m/%Y %H:%M:%S')"
          echo "üèÉ Status: ${{ job.status }}"
          echo ""
          echo "üìä Estat√≠sticas:"
          echo "   ‚Ä¢ Feed gerado: ${{ env.FEED_FILE || 'N/A' }}"
          echo "   ‚Ä¢ Not√≠cias (posts): ${{ env.POSTS_COUNT || 0 }}"
          echo "   ‚Ä¢ Total de itens: ${{ env.ITEMS_TOTAL || 0 }}"
          echo "   ‚Ä¢ Mudan√ßas detectadas: ${{ steps.gitcheck.outputs.changed || 'false' }}"
          echo ""
          
          if [[ "${{ steps.gitcheck.outputs.changed }}" == "true" ]]; then
            echo "‚úÖ Feed atualizado com sucesso!"
            echo ""
            echo "üîó Links:"
            echo "   ‚Ä¢ Feed WordPress:"
            echo "     https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.FEED_FILE || 'feed_agenciabrasil_wp.xml' }}"
            echo ""
            echo "   ‚Ä¢ Para importar no WordPress:"
            echo "     1. WordPress Admin ‚Üí Ferramentas ‚Üí Importar"
            echo "     2. Escolha 'WordPress'"
            echo "     3. Fa√ßa upload do arquivo XML acima"
          else
            echo "‚ÑπÔ∏è Nenhuma atualiza√ß√£o necess√°ria."
            echo "O feed j√° est√° atualizado."
          fi
          
          echo ""
          echo "üìã Workflow Run:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "====================================="

      # -----------------------------------------------------------
      - name: üö® Notifica√ß√£o de erro
        if: failure()
        run: |
          echo "‚ùå ERRO na execu√ß√£o do workflow!"
          echo ""
          echo "Detalhes:"
          echo "‚Ä¢ Reposit√≥rio: ${{ github.repository }}"
          echo "‚Ä¢ Workflow: ${{ github.workflow }}"
          echo "‚Ä¢ Run ID: ${{ github.run_id }}"
          echo "‚Ä¢ Branch: ${{ github.ref }}"
          echo ""
          echo "üîç Para depura√ß√£o:"
          echo "1. Verifique os logs acima"
          echo "2. Teste o script Python localmente:"
          echo "   python upnewsagenciabr.py"
          echo "3. Verifique se o arquivo XML √© gerado"
          echo ""
          echo "üîó URL da execu√ß√£o:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
