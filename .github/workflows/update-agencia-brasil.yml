name: Update AgÃªncia Brasil Feed

on:
  schedule:
    - cron: '0 */1 * * *'  # A cada 1 hora
  workflow_dispatch:       # ExecuÃ§Ã£o manual

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      - name: ğŸ“¥ Checkout (com histÃ³rico completo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      # -----------------------------------------------------------

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install beautifulsoup4 requests lxml
          echo "âœ… DependÃªncias instaladas"

      - name: ğŸš€ Executar script de extraÃ§Ã£o
        id: scraper
        run: |
          echo "ğŸ” Executando script upnewsagenciabr.py..."
          python upnewsagenciabr.py
          
          if [ -f "feed_agenciabrasil_wp.xml" ]; then
            # Contar itens no feed
            ITEMS=$(grep -c '<item>' feed_agenciabrasil_wp.xml || echo "0")
            # Contar apenas itens do tipo post (nÃ£o incluir attachments)
            POST_ITEMS=$(grep -c '<wp:post_type>post</wp:post_type>' feed_agenciabrasil_wp.xml || echo "0")
            
            echo "ğŸ“Š Total de itens: $ITEMS"
            echo "ğŸ“° Posts (notÃ­cias): $POST_ITEMS"
            echo "ITEMS_TOTAL=$ITEMS" >> $GITHUB_ENV
            echo "POSTS_COUNT=$POST_ITEMS" >> $GITHUB_ENV
            
            # Extrair data da Ãºltima atualizaÃ§Ã£o
            if [ -f "feed_agenciabrasil_wp.xml" ]; then
              LAST_BUILD=$(grep -oP '<lastBuildDate>\K[^<]+' feed_agenciabrasil_wp.xml | head -1 || echo "NÃ£o disponÃ­vel")
              echo "LAST_BUILD_DATE=$LAST_BUILD" >> $GITHUB_ENV
            fi
            
          else
            echo "âŒ ERRO: feed_agenciabrasil_wp.xml nÃ£o foi gerado"
            # Verificar se existe o arquivo antigo
            if [ -f "feed_agenciabrasil.xml" ]; then
              echo "âš ï¸  Usando arquivo antigo feed_agenciabrasil.xml"
              cp feed_agenciabrasil.xml feed_agenciabrasil_wp.xml
              ITEMS=$(grep -c '<item>' feed_agenciabrasil_wp.xml || echo "0")
              echo "ITEMS_TOTAL=$ITEMS" >> $GITHUB_ENV
              echo "POSTS_COUNT=$ITEMS" >> $GITHUB_ENV
            else
              exit 1
            fi
          fi

      # -----------------------------------------------------------
      - name: ğŸ”§ Configurar git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
      # -----------------------------------------------------------

      - name: ğŸ” Verificar mudanÃ§as
        id: gitcheck
        run: |
          # Verificar mudanÃ§as em qualquer arquivo XML
          if git diff --name-only | grep -q '\.xml$'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ AlteraÃ§Ãµes detectadas nos feeds XML."
            
            # Listar arquivos alterados
            echo "Arquivos modificados:"
            git status --porcelain | grep '\.xml$'
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhuma mudanÃ§a detectada nos feeds."
          fi

      # -----------------------------------------------------------
      - name: ğŸ’¾ Commit + Pull/Rebase + Push (Seguro)
        if: steps.gitcheck.outputs.changed == 'true'
        run: |
          # Adicionar todos os arquivos XML
          git add *.xml
          
          # Obter hora de BrasÃ­lia
          HORA_BRT=$(TZ="America/Sao_Paulo" date '+%d/%m/%Y %H:%M')
          
          # Mensagem de commit informativa
          COMMIT_MSG="ğŸ“° AtualizaÃ§Ã£o AgÃªncia Brasil - $HORA_BRT"
          COMMIT_MSG+=$'\n'
          COMMIT_MSG+="ğŸ“Š ${{ env.POSTS_COUNT }} notÃ­cias | Total itens: ${{ env.ITEMS_TOTAL }}"
          
          # Adicionar informaÃ§Ãµes extras se disponÃ­veis
          if [ -n "${{ env.LAST_BUILD_DATE }}" ]; then
            COMMIT_MSG+=$'\n'
            COMMIT_MSG+="ğŸ• Ãšltima build: ${{ env.LAST_BUILD_DATE }}"
          fi
          
          # Commit com mensagem detalhada
          git commit -m "$COMMIT_MSG"
          
          echo "ğŸ”„ Sincronizando com repositÃ³rio remoto..."
          # Tentar pull com rebase, se falhar, fazer merge
          git fetch origin
          git rebase origin/main || git pull --strategy-option=theirs || true
          
          echo "ğŸ“¤ Enviando alteraÃ§Ãµes..."
          # Tentar push, se falhar, forÃ§ar (apÃ³s rebase)
          git push origin main || git push --force-with-lease origin main
          
          echo "âœ… Push concluÃ­do com sucesso!"
          echo "Mensagem do commit:"
          echo "$COMMIT_MSG"
      # -----------------------------------------------------------

      - name: ğŸ“„ Criar arquivo de status
        run: |
          # Criar arquivo JSON com status da execuÃ§Ã£o
          cat > feed_status.json << EOF
          {
            "repository": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "timestamp_brt": "$(TZ='America/Sao_Paulo' date +'%Y-%m-%d %H:%M:%S')",
            "status": "success",
            "stats": {
              "total_items": ${{ env.ITEMS_TOTAL || 0 }},
              "posts_count": ${{ env.POSTS_COUNT || 0 }},
              "feed_file": "feed_agenciabrasil_wp.xml",
              "last_build": "${{ env.LAST_BUILD_DATE || 'N/A' }}"
            },
            "urls": {
              "raw_feed": "https://raw.githubusercontent.com/${{ github.repository }}/main/feed_agenciabrasil_wp.xml",
              "workflow_run": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
          }
          EOF
          
          echo "ğŸ“ Status salvo em feed_status.json"

      - name: ğŸ“Š Resumo da execuÃ§Ã£o
        run: |
          echo "====================================="
          echo "         AGÃŠNCIA BRASIL FEED"
          echo "====================================="
          echo "ğŸ“… ExecuÃ§Ã£o: $(TZ='America/Sao_Paulo' date '+%d/%m/%Y %H:%M:%S')"
          echo "ğŸ“Š EstatÃ­sticas:"
          echo "   â€¢ NotÃ­cias (posts): ${{ env.POSTS_COUNT || 0 }}"
          echo "   â€¢ Total de itens: ${{ env.ITEMS_TOTAL || 0 }}"
          echo "   â€¢ Arquivo gerado: feed_agenciabrasil_wp.xml"
          echo ""
          echo "ğŸ”— Links importantes:"
          echo "   â€¢ Feed WordPress:"
          echo "     https://raw.githubusercontent.com/${{ github.repository }}/main/feed_agenciabrasil_wp.xml"
          echo ""
          echo "   â€¢ Para importar no WordPress:"
          echo "     1. WordPress Admin â†’ Ferramentas â†’ Importar"
          echo "     2. Escolha 'WordPress'"
          echo "     3. FaÃ§a upload do arquivo XML acima"
          echo ""
          echo "ğŸ“‹ Status da execuÃ§Ã£o: âœ… SUCESSO"
          echo "====================================="

      - name: ğŸš¨ NotificaÃ§Ã£o em caso de erro
        if: failure()
        run: |
          echo "âŒ ERRO na execuÃ§Ã£o do workflow!"
          echo ""
          echo "RepositÃ³rio: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "Para depuraÃ§Ã£o:"
          echo "1. Verifique os logs acima"
          echo "2. Confira se o script Python funciona localmente"
          echo "3. Verifique as dependÃªncias instaladas"
          echo ""
          echo "ğŸ”— URL da execuÃ§Ã£o:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
