name: Update News ALCE Feed

on:
  schedule:
    - cron: '0 */1 * * *'  # A cada 1 hora
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      - name: üì• Checkout (com hist√≥rico completo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      # -----------------------------------------------------------

      - name: üêç Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üì¶ Instalar depend√™ncias
        run: |
          pip install -r requirements.txt

      - name: üöÄ Executar script de extra√ß√£o ALCE
        id: scraper
        run: |
          python upnewsalece.py

          if [ -f "feed_alce_news.xml" ]; then
            ITEMS=$(grep -c '<item>' feed_alce_news.xml || echo "0")
            echo "ITEMS_COUNT=$ITEMS" >> $GITHUB_ENV
          else
            echo "‚ùå ERRO: feed_alce_news.xml n√£o foi gerado"
            exit 1
          fi

      # -----------------------------------------------------------
      - name: üîß Configurar git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
      # -----------------------------------------------------------

      - name: üîç Verificar mudan√ßas
        id: gitcheck
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Nenhuma mudan√ßa detectada."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üü° Altera√ß√µes detectadas. Preparando commit..."
          fi

      # -----------------------------------------------------------
      - name: üíæ Commit + Pull/Rebase + Push (Seguro)
        if: steps.gitcheck.outputs.changed == 'true'
        run: |
          git add feed_alce_news.xml

          HORA_BRT=$(TZ="America/Fortaleza" date '+%d/%m %H:%M')
          COMMIT_MSG="Atualiza√ß√£o feed ALCE - $HORA_BRT (${{ env.ITEMS_COUNT }} not√≠cias)"

          git commit -m "$COMMIT_MSG"

          echo "üîÑ Sincronizando com reposit√≥rio remoto..."
          git pull --rebase || true

          echo "üì§ Enviando altera√ß√µes..."
          git push origin main

          echo "‚úÖ Push conclu√≠do com sucesso!"
      # -----------------------------------------------------------

      - name: üìÑ Resumo
        run: |
          echo "-------------------------------------"
          echo "Atualiza√ß√£o conclu√≠da"
          echo "Not√≠cias encontradas: ${{ env.ITEMS_COUNT }}"
          echo "Arquivo atualizado:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/feed_alce_news.xml"
          echo "-------------------------------------"
