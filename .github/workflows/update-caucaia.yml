name: Update Caucaia News Feed

on:
  # Agendamento: executa a cada 1 hora, das 8h √†s 22h (hor√°rio de Bras√≠lia)
  schedule:
    - cron: '0 11-23 * * *'  # 11:00-23:00 UTC = 08:00-20:00 BRT
    - cron: '0 0-1 * * *'    # 00:00-01:00 UTC = 21:00-22:00 BRT (dia anterior em UTC)
  
  # Permite execu√ß√£o manual
  workflow_dispatch:
  
  # Executa quando o script Python √© alterado
  push:
    paths:
      - 'upnewscaucaia.py'
      - '.github/workflows/update-caucaia.yml'

permissions:
  contents: write

jobs:
  update-feed:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar depend√™ncias
      run: |
        echo "üì¶ Instalando depend√™ncias..."
        python -m pip install --upgrade pip
        pip install beautifulsoup4 requests lxml html5lib
        echo "‚úÖ Depend√™ncias instaladas"
    
    - name: Verificar arquivo scraper
      run: |
        echo "üîç Verificando arquivo do scraper..."
        if [ -f "upnewscaucaia.py" ]; then
          echo "‚úÖ Arquivo upnewscaucaia.py encontrado"
          echo "üìÑ Tamanho: $(wc -l < upnewscaucaia.py) linhas"
        else
          echo "‚ùå Arquivo upnewscaucaia.py n√£o encontrado!"
          echo "üìÅ Arquivos no diret√≥rio:"
          ls -la
          exit 1
        fi
    
    - name: Executar scraper da Caucaia
      id: run_scraper
      run: |
        echo "üöÄ Iniciando scraping em $(date '+%d/%m/%Y %H:%M:%S') BRT"
        echo "‚è∞ Hor√°rio UTC: $(date -u '+%H:%M:%S')"
        
        TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
        
        # Executar o script Python
        echo "üìù Executando: python upnewscaucaia.py"
        python upnewscaucaia.py
        
        # Verificar resultado
        if [ $? -eq 0 ]; then
          echo "‚úÖ Script executado com sucesso"
          
          # Verificar qual arquivo foi gerado
          if [ -f "feed_caucaia.xml" ]; then
            FEED_FILE="feed_caucaia.xml"
          elif [ -f "feed_caucaia_limpo.xml" ]; then
            FEED_FILE="feed_caucaia_limpo.xml"
          elif [ -f "feed_caucaia_final.xml" ]; then
            FEED_FILE="feed_caucaia_final.xml"
          elif [ -f "feed_caucaia_completo.xml" ]; then
            FEED_FILE="feed_caucaia_completo.xml"
          else
            echo "‚ö†Ô∏è  Nenhum feed XML encontrado com nome padr√£o"
            FEED_FILE=""
          fi
          
          if [ -n "$FEED_FILE" ] && [ -f "$FEED_FILE" ]; then
            FILESIZE=$(stat -c%s "$FEED_FILE" 2>/dev/null || stat -f%z "$FEED_FILE")
            ITEMS_COUNT=$(grep -c "<item>" "$FEED_FILE" || echo "0")
            
            echo "üìä Feed gerado: $FEED_FILE"
            echo "   Tamanho: $((FILESIZE/1024)) KB"
            echo "   Itens: $ITEMS_COUNT"
            
            # Salvar estat√≠sticas
            echo "FEED_FILE=$FEED_FILE" >> $GITHUB_ENV
            echo "ITEMS_COUNT=$ITEMS_COUNT" >> $GITHUB_ENV
            echo "FILESIZE=$FILESIZE" >> $GITHUB_ENV
            echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
            
            # Mostrar primeiras linhas para debug
            echo "üîç Primeiras linhas do feed:"
            head -10 "$FEED_FILE"
          fi
        else
          echo "‚ùå Erro na execu√ß√£o do script"
          exit 1
        fi
    
    - name: Verificar mudan√ßas no reposit√≥rio
      id: check_changes
      run: |
        echo "üîç Verificando mudan√ßas..."
        
        # Verificar status atual
        git status
        
        # Verificar mudan√ßas no arquivo de feed
        if [ -n "${{ env.FEED_FILE }}" ] && [ -f "${{ env.FEED_FILE }}" ]; then
          if git diff --quiet HEAD -- "${{ env.FEED_FILE }}"; then
            echo "üì≠ Nenhuma mudan√ßa no feed ${{ env.FEED_FILE }}"
            echo "CHANGED=false" >> $GITHUB_ENV
          else
            echo "üì¨ Mudan√ßas detectadas no feed!"
            echo "CHANGED=true" >> $GITHUB_ENV
            
            # Mostrar diff resumido
            echo "üìã Resumo das mudan√ßas:"
            git diff --stat HEAD -- "${{ env.FEED_FILE }}"
          fi
        else
          echo "‚ö†Ô∏è  Nenhum arquivo de feed para verificar"
          echo "CHANGED=false" >> $GITHUB_ENV
        fi
    
    - name: Commit e push das atualiza√ß√µes
      if: env.CHANGED == 'true'
      run: |
        echo "üì§ Preparando commit..."
        
        # Configurar git
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # Adicionar todos os arquivos XML gerados
        git add *.xml
        
        # Criar mensagem de commit
        COMMIT_TIME_BRT=$(TZ="America/Fortaleza" date '+%d/%m/%Y %H:%M')
        COMMIT_MSG="ü§ñ Atualiza√ß√£o autom√°tica - $COMMIT_TIME_BRT"
        
        if [ -n "${{ env.ITEMS_COUNT }}" ]; then
          COMMIT_MSG="$COMMIT_MSG | ${{ env.ITEMS_COUNT }} not√≠cias"
        fi
        
        # Fazer commit
        git commit -m "$COMMIT_MSG"
        
        # Fazer push
        echo "üöÄ Enviando para o GitHub..."
        git push origin main
        
        echo "‚úÖ Feed atualizado com sucesso!"
    
    - name: Sem atualiza√ß√µes necess√°rias
      if: env.CHANGED == 'false'
      run: |
        echo "‚úÖ Feed j√° est√° atualizado"
        echo "‚è∞ Pr√≥xima execu√ß√£o em 1 hora"
        
        if [ -n "${{ env.ITEMS_COUNT }}" ]; then
          echo "üìä Status atual:"
          echo "   - Feed: ${{ env.FEED_FILE }}"
          echo "   - Not√≠cias: ${{ env.ITEMS_COUNT }}"
          echo "   - √öltima atualiza√ß√£o: ${{ env.TIMESTAMP }}"
        fi
    
    - name: Logs finais
      run: |
        echo "========================================"
        echo "üìã RESUMO DA EXECU√á√ÉO"
        echo "========================================"
        echo "‚úÖ Workflow conclu√≠do"
        echo "üïê Hor√°rio: $(TZ="America/Fortaleza" date '+%H:%M:%S') BRT"
        
        if [ -n "${{ env.FEED_FILE }}" ]; then
          echo "üìÑ Feed: ${{ env.FEED_FILE }}"
          echo "üîó URL: https://raw.githubusercontent.com/${{ github.repository }}/main/${{ env.FEED_FILE }}"
        fi
        
        if [ -n "${{ env.ITEMS_COUNT }}" ]; then
          echo "üì∞ Not√≠cias no feed: ${{ env.ITEMS_COUNT }}"
        fi
        
        if [ "${{ env.CHANGED }}" = "true" ]; then
          echo "üîÑ Feed foi atualizado"
        else
          echo "‚ö° Feed j√° estava atualizado"
        fi
        
        echo "‚è≥ Pr√≥xima execu√ß√£o autom√°tica em 1 hora"
        echo "========================================"
