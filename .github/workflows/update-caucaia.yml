name: ğŸ—ï¸ Atualizar Feed Caucaia

on:
  schedule:
    - cron: '0 11-23,0-1 * * *'  # 8h-22h BRT
  workflow_dispatch:

# âœ… PERMISSÃ•ES CORRETAS
permissions:
  contents: write  # ESSENCIAL para poder fazer push

jobs:
  update-feed:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Baixar repositÃ³rio COM TOKEN
    - name: ğŸ“¥ Checkout com token
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # âœ… TOKEN NECESSÃRIO
        fetch-depth: 0
    
    # 2. Configurar Python
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. Instalar dependÃªncias
    - name: ğŸ“¦ Instalar bibliotecas
      run: |
        pip install beautifulsoup4 requests
    
    # 4. Executar scraper
    - name: ğŸš€ Executar scraper
      id: scraper
      run: |
        echo "â–¶ï¸ Executando scraper..."
        python upnewscaucaia.py
        
        echo "ğŸ“Š Verificando resultado..."
        if [ -f "feed_caucaia_limpo.xml" ]; then
          ITEMS=$(grep -c '<item>' feed_caucaia_limpo.xml || echo "0")
          SIZE=$(wc -c < feed_caucaia_limpo.xml)
          echo "âœ… feed_caucaia_limpo.xml gerado"
          echo "ğŸ“° Itens: $ITEMS"
          echo "ğŸ“ Tamanho: $((SIZE/1024)) KB"
          
          echo "ITEMS_COUNT=$ITEMS" >> $GITHUB_ENV
        else
          echo "âŒ ERRO: feed_caucaia_limpo.xml nÃ£o foi gerado!"
          ls -la
          exit 1
        fi
    
    # 5. Configurar git CORRETAMENTE
    - name: âš™ï¸ Configurar git
      run: |
        echo "âš™ï¸ Configurando git..."
        
        # Configurar usuÃ¡rio do GitHub Actions
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Configurar remote com token
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
    
    # 6. Fazer commit e push
    - name: ğŸ’¾ Commit e push
      run: |
        echo "ğŸ’¾ Preparando commit..."
        
        # Adicionar timestamp ÃšNICO para forÃ§ar mudanÃ§a
        TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
        echo "<!-- GitHub Actions Update: $TIMESTAMP -->" | cat - feed_caucaia_limpo.xml > temp.xml
        mv temp.xml feed_caucaia_limpo.xml
        
        # Adicionar ao git
        git add feed_caucaia_limpo.xml
        
        # Verificar status
        echo "ğŸ“‹ Status git:"
        git status
        
        # Criar mensagem
        HORA_BRT=$(TZ="America/Fortaleza" date '+%d/%m %H:%M')
        COMMIT_MSG="ğŸ¤– AtualizaÃ§Ã£o feed Caucaia - $HORA_BRT (${{ env.ITEMS_COUNT }} notÃ­cias)"
        
        # Fazer commit
        git commit -m "$COMMIT_MSG" || echo "âš ï¸ Nenhuma mudanÃ§a detectada, criando commit vazio..." && git commit --allow-empty -m "$COMMIT_MSG"
        
        # Fazer push
        echo "ğŸš€ Fazendo push..."
        git push origin main
        
        echo "âœ… Push realizado com sucesso!"
    
    # 7. Resumo
    - name: ğŸ“‹ Resumo
      run: |
        echo "========================================"
        echo "          ğŸ‰ ATUALIZAÃ‡ÃƒO CONCLUÃDA"
        echo "========================================"
        echo "âœ… Feed atualizado no repositÃ³rio"
        echo "ğŸ“° NotÃ­cias: ${{ env.ITEMS_COUNT }}"
        echo "ğŸ• Hora BRT: $(TZ="America/Fortaleza" date '+%H:%M:%S')"
        echo "ğŸ”— URL do feed:"
        echo "https://raw.githubusercontent.com/${{ github.repository }}/main/feed_caucaia_limpo.xml"
        echo "========================================"
