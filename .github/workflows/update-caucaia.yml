name: ğŸ”„ Atualizar Feed Caucaia

on:
  # A cada hora das 8h Ã s 22h BRT
  schedule:
    - cron: '0 11,12,13,14,15,16,17,18,19,20,21,22,23,0,1 * * *'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

permissions:
  contents: write

jobs:
  atualizar-feed:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Baixar cÃ³digo
    - name: ğŸ“¥ Baixar repositÃ³rio
      uses: actions/checkout@v4
    
    # 2. Configurar Python
    - name: ğŸ Configurar Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. Instalar bibliotecas
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install beautifulsoup4 requests
    
    # 4. Executar script
    - name: ğŸš€ Executar scraper
      run: |
        echo "â° Iniciando em: $(date)"
        echo "ğŸ“ DiretÃ³rio atual: $(pwd)"
        echo "ğŸ“„ Listando arquivos:"
        ls -la
        
        echo "ğŸ”§ Executando scraper..."
        python upnewscaucaia.py
        
        echo "âœ… Scraper finalizado"
        echo "ğŸ“Š Verificando resultado..."
        
        if [ -f "feed_caucaia_limpo.xml" ]; then
          echo "ğŸ‰ Arquivo gerado: feed_caucaia_limpo.xml"
          echo "ğŸ“ Tamanho: $(wc -c < feed_caucaia_limpo.xml) bytes"
          echo "ğŸ“° NotÃ­cias: $(grep -c '<item>' feed_caucaia_limpo.xml)"
        else
          echo "âŒ Arquivo nÃ£o foi gerado!"
          echo "ğŸ“ Listando XMLs:"
          ls -la *.xml 2>/dev/null || echo "Nenhum XML encontrado"
          exit 1
        fi
    
    # 5. Verificar se houve mudanÃ§as
    - name: ğŸ” Verificar mudanÃ§as
      id: check-changes
      run: |
        echo "ğŸ” Verificando se o feed mudou..."
        
        # Verificar status
        git status
        
        # Verificar diferenÃ§as
        if git diff --quiet HEAD -- feed_caucaia_limpo.xml; then
          echo "ğŸ“­ Nenhuma mudanÃ§a detectada"
          echo "changed=false" >> $GITHUB_ENV
        else
          echo "ğŸ“¬ MudanÃ§as detectadas!"
          echo "changed=true" >> $GITHUB_ENV
          
          # Mostrar diff
          echo "ğŸ“ DiferenÃ§as:"
          git diff --stat HEAD -- feed_caucaia_limpo.xml
        fi
    
    # 6. Fazer commit apenas se houver mudanÃ§as
    - name: ğŸ’¾ Salvar atualizaÃ§Ãµes
      if: env.changed == 'true'
      run: |
        echo "ğŸ’¾ Configurando git..."
        
        git config --local user.name "GitHub Actions"
        git config --local user.email "actions@github.com"
        
        echo "ğŸ“¤ Adicionando arquivo..."
        git add feed_caucaia_limpo.xml
        
        echo "ğŸ“ Criando commit..."
        HORA_BRT=$(TZ="America/Fortaleza" date '+%d/%m/%Y %H:%M')
        git commit -m "ğŸ¤– AtualizaÃ§Ã£o automÃ¡tica feed Caucaia - $HORA_BRT"
        
        echo "ğŸš€ Enviando para GitHub..."
        git push
        
        echo "âœ… Feed atualizado com sucesso!"
    
    # 7. Se nÃ£o houver mudanÃ§as
    - name: â¸ï¸  Sem atualizaÃ§Ãµes
      if: env.changed == 'false'
      run: |
        echo "âœ… Feed jÃ¡ estÃ¡ atualizado"
        echo "â° PrÃ³xima execuÃ§Ã£o em 1 hora"
        echo "ğŸ”— URL atual: https://raw.githubusercontent.com/${{ github.repository }}/main/feed_caucaia_limpo.xml"
    
    # 8. Resumo final
    - name: ğŸ“‹ Resumo
      run: |
        echo "========================================"
        echo "          ğŸ“‹ RESUMO DA EXECUÃ‡ÃƒO"
        echo "========================================"
        echo "ğŸ• Hora: $(TZ="America/Fortaleza" date '+%H:%M:%S') BRT"
        echo "ğŸ“ RepositÃ³rio: ${{ github.repository }}"
        
        if [ -f "feed_caucaia_limpo.xml" ]; then
          ITEMS=$(grep -c '<item>' feed_caucaia_limpo.xml || echo "0")
          SIZE=$(wc -c < feed_caucaia_limpo.xml)
          echo "ğŸ“„ Feed: feed_caucaia_limpo.xml"
          echo "ğŸ“° NotÃ­cias: $ITEMS"
          echo "ğŸ“ Tamanho: $((SIZE/1024)) KB"
          echo "ğŸ”— URL: https://raw.githubusercontent.com/${{ github.repository }}/main/feed_caucaia_limpo.xml"
        fi
        
        if [ "${{ env.changed }}" = "true" ]; then
          echo "ğŸ”„ Status: ATUALIZADO"
        else
          echo "âš¡ Status: JÃ ATUALIZADO"
        fi
        
        echo "â³ PrÃ³xima: Em 1 hora"
        echo "========================================"
