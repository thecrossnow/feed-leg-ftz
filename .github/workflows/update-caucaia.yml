name: ğŸ”„ Atualizar Feed Caucaia

on:
  schedule:
    - cron: '0 11-23,0-1 * * *'  # 8h-22h BRT
  
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Baixar repositÃ³rio
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install beautifulsoup4 requests lxml
    
    - name: ğŸš€ Executar scraper
      id: run-scraper
      run: |
        echo "â–¶ï¸ Executando upnewscaucaia.py..."
        python upnewscaucaia.py
        
        echo "ğŸ“Š Resultado:"
        ls -la *.xml 2>/dev/null || echo "âš ï¸ Nenhum XML encontrado"
        
        if [ -f "feed_caucaia_limpo.xml" ]; then
          echo "âœ… feed_caucaia_limpo.xml criado!"
          ITEMS=$(grep -c '<item>' feed_caucaia_limpo.xml || echo "0")
          SIZE=$(wc -c < feed_caucaia_limpo.xml)
          echo "ğŸ“° Itens: $ITEMS"
          echo "ğŸ“ Tamanho: $((SIZE/1024)) KB"
          
          # Salvar para uso posterior
          echo "ITEMS_COUNT=$ITEMS" >> $GITHUB_ENV
        else
          echo "âŒ ERRO: feed_caucaia_limpo.xml nÃ£o foi criado!"
          exit 1
        fi
    
    - name: ğŸ’¾ Commit e push
      if: success()
      run: |
        git config --local user.name "GitHub Actions"
        git config --local user.email "actions@github.com"
        
        # Verificar se hÃ¡ mudanÃ§as
        if git diff --quiet HEAD -- feed_caucaia_limpo.xml; then
          echo "ğŸ“­ Nenhuma mudanÃ§a no feed"
        else
          echo "ğŸ“¬ Feed alterado - fazendo commit..."
          git add feed_caucaia_limpo.xml
          
          HORA_BRT=$(TZ="America/Fortaleza" date '+%d/%m %H:%M')
          git commit -m "ğŸ¤– Update feed Caucaia (${{ env.ITEMS_COUNT }} notÃ­cias) - $HORA_BRT"
          git push
          
          echo "âœ… Feed atualizado no GitHub!"
        fi
    
    - name: ğŸ“‹ Resumo
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“‹ RESUMO"
        echo "========================================"
        echo "âœ… Workflow concluÃ­do"
        echo "ğŸ“… Hora BRT: $(TZ="America/Fortaleza" date '+%H:%M:%S')"
        
        if [ -f "feed_caucaia_limpo.xml" ]; then
          echo "ğŸ“„ Feed: feed_caucaia_limpo.xml"
          echo "ğŸ“° NotÃ­cias: ${{ env.ITEMS_COUNT }}"
          echo "ğŸ”— URL: https://raw.githubusercontent.com/${{ github.repository }}/main/feed_caucaia_limpo.xml"
        fi
        
        echo "â³ PrÃ³xima execuÃ§Ã£o em 1 hora"
        echo "========================================"
