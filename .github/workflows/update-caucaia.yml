name: Atualizar Feed Caucaia

on:
  schedule:
    - cron: '0 */1 * * *'  # A cada 1 horas
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-feed:
    runs-on: ubuntu-latest
    
    steps:
    # -----------------------------------------------------------
    - name: ğŸ“¥ Checkout (com histÃ³rico completo)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    # -----------------------------------------------------------

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install beautifulsoup4 requests lxml

    - name: ğŸš€ Executar scraper
      id: scraper
      run: |
        python upnewscaucaia.py
        
        if [ -f "feed_caucaia_limpo.xml" ]; then
          ITEMS=$(grep -c '<item>' feed_caucaia_limpo.xml || echo "0")
          echo "ITEMS_COUNT=$ITEMS" >> $GITHUB_ENV
        else
          echo "âŒ ERRO: feed_caucaia_limpo.xml nÃ£o foi gerado"
          exit 1
        fi

    # -----------------------------------------------------------
    - name: ğŸ”§ Configurar git
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
    # -----------------------------------------------------------

    - name: ğŸ” Verificar mudanÃ§as
      id: gitcheck
      run: |
        if [[ -z "$(git status --porcelain)" ]]; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Nenhuma mudanÃ§a detectada."
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸŸ¡ AlteraÃ§Ãµes detectadas. Preparando commit..."
        fi

    # -----------------------------------------------------------
    - name: ğŸ’¾ Commit + Pull/Rebase + Push (Seguro)
      if: steps.gitcheck.outputs.changed == 'true'
      run: |
        git add feed_caucaia_limpo.xml

        HORA_BRT=$(TZ="America/Fortaleza" date '+%d/%m %H:%M')
        COMMIT_MSG="AtualizaÃ§Ã£o feed Caucaia - $HORA_BRT (${{ env.ITEMS_COUNT }} notÃ­cias)"

        git commit -m "$COMMIT_MSG"

        echo "ğŸ”„ Sincronizando com repositÃ³rio remoto..."
        git pull --rebase || true

        echo "ğŸ“¤ Enviando alteraÃ§Ãµes..."
        git push origin main

        echo "âœ… Push concluÃ­do com sucesso!"
    # -----------------------------------------------------------

    - name: ğŸ“„ Resumo
      run: |
        echo "-------------------------------------"
        echo "AtualizaÃ§Ã£o concluÃ­da"
        echo "NotÃ­cias encontradas: ${{ env.ITEMS_COUNT }}"
        echo "Arquivo atualizado:"
        echo "https://raw.githubusercontent.com/${{ github.repository }}/main/feed_caucaia_limpo.xml"
        echo "-------------------------------------"
