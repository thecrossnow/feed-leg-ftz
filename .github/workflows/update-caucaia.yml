name: ğŸ—ï¸ Update Caucaia News Feed

on:
  # A cada 1 hora das 8h Ã s 22h (horÃ¡rio de BrasÃ­lia)
  schedule:
    - cron: '0 11,12,13,14,15,16,17,18,19,20,21,22,23,0,1 * * *'  # 8h-22h BRT
  
  # ExecuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o mesmo sem mudanÃ§as?'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

  # Executa quando o script Ã© alterado
  push:
    paths:
      - 'upnewscaucaia.py'
      - '.github/workflows/update-caucaia.yml'

permissions:
  contents: write

jobs:
  update-feed:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install beautifulsoup4 requests
    
    - name: ğŸ” Verificar ambiente
      run: |
        echo "ğŸ“… Data/hora UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“… Data/hora BRT: $(TZ="America/Fortaleza" date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“ DiretÃ³rio: $(pwd)"
        echo "ğŸ“„ Arquivos:"
        ls -la
        
        # Verificar se o script existe
        if [ -f "upnewscaucaia.py" ]; then
          echo "âœ… Script upnewscaucaia.py encontrado"
          echo "ğŸ“ Tamanho: $(wc -l < upnewscaucaia.py) linhas"
        else
          echo "âŒ ERRO: upnewscaucaia.py nÃ£o encontrado!"
          exit 1
        fi
    
    - name: ğŸš€ Executar scraper
      id: scraper
      run: |
        echo "â–¶ï¸  Iniciando scraper..."
        
        # Criar timestamp para log
        TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        
        # Executar script Python
        if python upnewscaucaia.py; then
          echo "âœ… Scraper executado com sucesso"
          
          # Encontrar o arquivo de feed gerado
          for feed in feed_caucaia.xml feed_caucaia_limpo.xml feed_caucaia_final.xml feed_caucaia_completo.xml; do
            if [ -f "$feed" ]; then
              echo "ğŸ“„ Feed encontrado: $feed"
              FILESIZE=$(wc -c < "$feed")
              ITEMS=$(grep -c "<item>" "$feed" || echo "0")
              
              echo "FEED_FILE=$feed" >> $GITHUB_ENV
              echo "FILESIZE=$FILESIZE" >> $GITHUB_ENV
              echo "ITEMS_COUNT=$ITEMS" >> $GITHUB_ENV
              
              echo "ğŸ“Š EstatÃ­sticas:"
              echo "   - Tamanho: $((FILESIZE/1024)) KB"
              echo "   - Itens: $ITEMS"
              echo "   - Linhas: $(wc -l < "$feed")"
              break
            fi
          done
          
          # Se nÃ£o encontrou nenhum feed
          if [ -z "${FEED_FILE:-}" ]; then
            echo "âš ï¸  Nenhum feed XML foi gerado"
            echo "ğŸ“ Listando arquivos *.xml:"
            ls -la *.xml 2>/dev/null || echo "Nenhum arquivo XML encontrado"
          fi
          
        else
          echo "âŒ ERRO: Falha na execuÃ§Ã£o do scraper"
          exit 1
        fi
    
    - name: ğŸ”„ Verificar mudanÃ§as
      id: check-changes
      if: success() && env.FEED_FILE != ''
      run: |
        echo "ğŸ” Verificando se o feed foi alterado..."
        
        # Mostrar status atual
        echo "ğŸ“‹ Status git:"
        git status --short
        
        # Verificar se hÃ¡ mudanÃ§as no feed
        if git diff --quiet HEAD -- "$FEED_FILE"; then
          echo "ğŸ“­ Nenhuma alteraÃ§Ã£o no feed"
          echo "CHANGED=false" >> $GITHUB_ENV
        else
          echo "ğŸ“¬ Feed alterado!"
          echo "CHANGED=true" >> $GITHUB_ENV
          
          # Mostrar diferenÃ§as
          echo "ğŸ“ DiferenÃ§as encontradas:"
          git diff --stat HEAD -- "$FEED_FILE"
        fi
    
    - name: ğŸ’¾ Commit das atualizaÃ§Ãµes
      if: success() && env.CHANGED == 'true'
      run: |
        echo "ğŸ’¾ Salvando alteraÃ§Ãµes..."
        
        # Configurar git
        git config --local user.name "GitHub Actions Bot"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        
        # Adicionar apenas o feed
        git add "$FEED_FILE"
        
        # Criar mensagem de commit
        COMMIT_TIME_BRT=$(TZ="America/Fortaleza" date '+%d/%m/%Y %H:%M')
        COMMIT_MSG="ğŸ“° AtualizaÃ§Ã£o feed Caucaia - $COMMIT_TIME_BRT"
        
        if [ -n "${ITEMS_COUNT:-}" ]; then
          COMMIT_MSG="$COMMIT_MSG ($ITEMS_COUNT notÃ­cias)"
        fi
        
        # Fazer commit
        git commit -m "$COMMIT_MSG"
        
        # Fazer push
        echo "ğŸš€ Enviando para GitHub..."
        git push
        
        echo "âœ… Feed atualizado com sucesso!"
        echo "ğŸ”— URL: https://raw.githubusercontent.com/${{ github.repository }}/main/$FEED_FILE"
    
    - name: âœ… Nada para atualizar
      if: success() && env.CHANGED == 'false'
      run: |
        echo "âœ… Feed jÃ¡ estÃ¡ atualizado"
        echo "â° PrÃ³xima execuÃ§Ã£o em 1 hora"
        echo "ğŸ“Š Feed atual: $FEED_FILE ($ITEMS_COUNT notÃ­cias)"
    
    - name: ğŸ“‹ Resumo final
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“‹ RESUMO DA EXECUÃ‡ÃƒO"
        echo "========================================"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… STATUS: SUCESSO"
          
          if [ -n "${FEED_FILE:-}" ]; then
            echo "ğŸ“„ Feed: $FEED_FILE"
            
            if [ -n "${ITEMS_COUNT:-}" ]; then
              echo "ğŸ“° NotÃ­cias: $ITEMS_COUNT"
            fi
            
            if [ "${CHANGED:-}" = "true" ]; then
              echo "ğŸ”„ Atualizado: SIM"
            else
              echo "ğŸ”„ Atualizado: NÃƒO (jÃ¡ estava atualizado)"
            fi
          fi
          
          echo "ğŸ”— URL do feed:"
          echo "   https://raw.githubusercontent.com/${{ github.repository }}/main/$FEED_FILE"
          
        else
          echo "âŒ STATUS: FALHA"
          echo "âš ï¸  Verifique os logs acima"
        fi
        
        echo "â° Hora BRT: $(TZ="America/Fortaleza" date '+%H:%M:%S')"
        echo "========================================"
