name: ğŸ—ï¸ Atualizar Feed Caucaia

on:
  schedule:
    - cron: '0 11-23,0-1 * * *'  # 8h-22h BRT
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-feed:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Baixar repositÃ³rio
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. Configurar Python
    - name: ğŸ Configurar Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. Instalar dependÃªncias
    - name: ğŸ“¦ Instalar bibliotecas
      run: |
        pip install beautifulsoup4 requests
    
    # 4. Executar scraper
    - name: ğŸš€ Executar scraper
      id: scraper
      run: |
        echo "â–¶ï¸ Executando scraper..."
        python upnewscaucaia.py
        
        echo "ğŸ“Š Verificando resultado..."
        if [ -f "feed_caucaia_limpo.xml" ]; then
          ITEMS=$(grep -c '<item>' feed_caucaia_limpo.xml || echo "0")
          SIZE=$(wc -c < feed_caucaia_limpo.xml)
          echo "âœ… feed_caucaia_limpo.xml gerado"
          echo "ğŸ“° Itens: $ITEMS"
          echo "ğŸ“ Tamanho: $((SIZE/1024)) KB"
          
          # Adicionar timestamp ÃšNICO ao arquivo para forÃ§ar mudanÃ§a
          TIMESTAMP=$(date '+%s')
          sed -i "1a <!-- Ãšltima atualizaÃ§Ã£o: $TIMESTAMP -->" feed_caucaia_limpo.xml
          
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "ITEMS_COUNT=$ITEMS" >> $GITHUB_ENV
        else
          echo "âŒ ERRO: feed_caucaia_limpo.xml nÃ£o foi gerado!"
          ls -la
          exit 1
        fi
    
    # 5. FORÃ‡AR commit SEMPRE
    - name: ğŸ’¾ Commit FORÃ‡ADO
      run: |
        echo "ğŸ’¾ Preparando commit FORÃ‡ADO..."
        
        # Configurar git
        git config --local user.name "GitHub Actions"
        git config --local user.email "actions@github.com"
        
        # FORÃ‡AR mudanÃ§a: adicionar linha de comentÃ¡rio com timestamp
        echo "<!-- GitHub Actions Update: $(date '+%Y-%m-%d %H:%M:%S UTC') -->" >> feed_caucaia_limpo.xml
        
        # Adicionar arquivo
        git add feed_caucaia_limpo.xml
        
        # Criar mensagem de commit
        HORA_BRT=$(TZ="America/Fortaleza" date '+%d/%m %H:%M')
        COMMIT_MSG="ğŸ¤– AtualizaÃ§Ã£o feed Caucaia - $HORA_BRT"
        
        if [ -n "${ITEMS_COUNT:-}" ]; then
          COMMIT_MSG="$COMMIT_MSG ($ITEMS_COUNT notÃ­cias)"
        fi
        
        # Sempre fazer commit (--allow-empty se necessÃ¡rio)
        git commit -m "$COMMIT_MSG" || git commit --allow-empty -m "$COMMIT_MSG"
        
        # Fazer push
        echo "ğŸš€ Enviando para GitHub..."
        git push
        
        echo "âœ… Feed atualizado no repositÃ³rio!"
    
    # 6. Resumo
    - name: ğŸ“‹ Resumo
      run: |
        echo "========================================"
        echo "          ğŸ‰ ATUALIZAÃ‡ÃƒO CONCLUÃDA"
        echo "========================================"
        echo "âœ… Feed: feed_caucaia_limpo.xml"
        echo "ğŸ“° NotÃ­cias: ${{ env.ITEMS_COUNT }}"
        echo "ğŸ• Hora BRT: $(TZ="America/Fortaleza" date '+%H:%M:%S')"
        echo "ğŸ”— URL: https://raw.githubusercontent.com/${{ github.repository }}/main/feed_caucaia_limpo.xml"
        echo "========================================"
